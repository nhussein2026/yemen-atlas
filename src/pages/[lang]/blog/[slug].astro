---
import { getCollection } from "astro:content";
import { assertLang } from "../../../lib/lang";
import BaseLayout from "../../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return ["en", "ar"].flatMap((lang) =>
    posts.map((post) => ({
      params: { lang, slug: post.slug },
      props: { post, lang },
    }))
  );
}

const { post, lang } = Astro.props;
assertLang(lang);

// Render the markdown content as fallback
const { Content } = await post.render();

// Simple markdown formatter for content from frontmatter
function formatMarkdown(text: string): string {
  let html = text;
  
  // Convert ## headers
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  // Convert ### headers
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  // Convert bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Convert bullet lists
  html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*?<\/li>)/s, '<ul>$1</ul>');
  // Convert paragraph breaks
  html = html.replace(/\n\n+/g, '</p><p>');
  html = '<p>' + html + '</p>';
  
  return html;
}
---

<BaseLayout
  lang={lang}
  title={post.data.title[lang]}
  description={post.data.excerpt[lang]}
>
  <article>
    <h1>{post.data.title[lang]}</h1>
    <p class="excerpt">{post.data.excerpt[lang]}</p>

    {
      post.data.publishedAt && (
        <time datetime={post.data.publishedAt.toISOString()}>
          {post.data.publishedAt.toLocaleDateString(
            lang === "ar" ? "ar" : "en"
          )}
        </time>
      )
    }

    {
      post.data.tags && post.data.tags.length > 0 && (
        <div class="tags">
          {post.data.tags.map((tag) => (
            <span class="tag">{tag}</span>
          ))}
        </div>
      )
    }

    {/* Display bilingual content from frontmatter if available */}
    {post.data.content && post.data.content[lang] ? (
      <div class="prose" set:html={formatMarkdown(post.data.content[lang])} />
    ) : (
      <Content />
    )}

    {
      post.data.sources && post.data.sources.length > 0 && (
        <footer>
          <h2>Sources</h2>
          <ul>
            {post.data.sources.map((source) => (
              <li>{source}</li>
            ))}
          </ul>
        </footer>
      )
    }
  </article>
</BaseLayout>

<style>
  .prose {
    line-height: 1.8;
    color: var(--text-dark, #222);
  }

  .prose p {
    margin: 1rem 0;
  }

  .prose h2 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--archive-ink, #1b2430);
  }

  .prose h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--yemeni-earth, #8b6f47);
  }

  .prose strong {
    font-weight: 600;
    color: var(--yemeni-earth, #8b6f47);
  }

  .prose ul {
    margin: 1rem 0;
    padding-left: 2rem;
    list-style: disc;
  }

  .prose li {
    margin: 0.5rem 0;
  }

  .prose a {
    color: var(--yemeni-earth, #8b6f47);
    text-decoration: underline;
  }

  .prose a:hover {
    opacity: 0.8;
  }
</style>
